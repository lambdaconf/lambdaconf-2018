define(["require","exports","tslib","react","external/lodash","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/analytics","modules/clean/annotations/annotation","modules/clean/comments/action_creators_helpers","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/logged_out_utils","modules/clean/comments/models/comment_activity","modules/clean/comments/revisions","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/file_activity/api","modules/clean/file_activity/clients/file_activity_data_source","modules/clean/file_activity/models/immutability_helper","modules/clean/react/file_comments/onboarding","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_viewer/utils","modules/clean/react/modal","modules/clean/storage","modules/constants/comments_panel","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/comments/legacy_redux_integration"],function(t,e,n,o,a,i,r,s,c,m,u,l,d,f,v,y,g,_,C,p,h,I,x,A,b,S,w,K,L,V){"use strict";function O(){var t=y.default.state.actorId,e=y.default.state.shouldShowOnboarding,n=y.default.state.viewing,o=n.context,a=n.file,i=x.getFileViewerInterfaceType(o,a&&a.preview_type);if(null!=t&&null!=i){if(null==e)return _.shouldShowCommentingOnboarding({actorId:t}).then(function(t){if(u.default.setShouldShowOnboarding(t),t)return Q()}).catch(function(){});if(e===!0)return Q()}}function T(t,e){return void 0!==t&&null!==t?e(t):void 0}Object.defineProperty(e,"__esModule",{value:!0}),o=n.__importDefault(o),a=n.__importStar(a),r=n.__importStar(r),m=n.__importStar(m),u=n.__importDefault(u),d=n.__importStar(d),y=n.__importDefault(y),g=n.__importStar(g),_=n.__importStar(_),C=n.__importDefault(C),h=n.__importDefault(h);var k=function(t,e){var n=C.default.getInstance().commitOptimisticUpdate(e);return t.then(function(t){return C.default.getInstance().rebase(n),t}),t.catch(function(t){return C.default.getInstance().rollbackOptimisticUpdate(n),Promise.reject(t)})},E=function(t){var e=t.targetActivityKey,n=t.pendingCommentActivity,o=y.default.state.activity.activity_key,a=e===o?null:e,i=n.comment,r=i.raw_comment_text,s=i.comment_metadata,c=_.addComment({actorId:y.default.state.actorId,context:y.default.state.viewing.context,contextData:y.default.state.viewing.contextData,commentActivityKey:a,text:r,metadata:null!=s?s.toDict():void 0,oref:y.default.state.oref}),m=C.default.getInstance().commitOptimisticUpdate(function(t){return t.appendComment(e,n)});return c.then(function(t){var n=C.default.getInstance();return n.rollbackOptimisticUpdate(m),n.rebase(function(n){return n.appendComment(e,t)})}),[c,m]},D=function(t,e){return p.merge(t,{status:"FAILED",activity_key:e})},U=function(t){var e=t.targetActivityKey,n=t.body,o=t.annotation,a=g.getActivityUser(y.default.state.actorId);y.default.state.activity.activity_key;var i=null!=n.text?n.text:"",r=m.buildCommentMetadata(n,o),s=f.CommentActivity.createLocalInstance({commenter:a,rawCommentText:i,metadata:r,status:"POSTING"}),c=Array.from(E({targetActivityKey:e,pendingCommentActivity:s})),u=c[0],l=c[1];return u.catch(function(t){var n=C.default.getInstance();return n.rollbackOptimisticUpdate(l),n.commitOptimisticUpdate(function(t,n){var o=D(s,n);return t.appendComment(e,o)}),Promise.reject(t)}),[s,u]},P=function(t,e,n){var o=g.getActivityUser(y.default.state.actorId),a=y.default.state.activity.activity_key;if(!o.is_signed_in)return d.saveActionCreator({name:t,fileActivityKey:a,args:e}),l.CommentsEvents.emit("show-sign-up-modal",{fileActivityKey:a,variant:I.CommentsSharedLinkSignupModals.POST_COMMENT_VARIANT}),d.logSignUpModal({fileActivityKey:a,commentActivityKey:n,originType:S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.POST_BUTTON}),b.LocalStorage.set("tmp-file-comment",null),!1;if(!o.is_email_verified){var s=i.EmailVerification.get_for_user(o);return i.EmailVerification.set_should_use_simple_ui(!1),s.show_verify_modal(null,r.ADD_COMMENT),!1}return!0},B=function(t){var e=t.targetActivityKey,n=t.pendingCommentActivity;s.CommentsVortexLogger.log("retry-post-attempt"),C.default.getInstance().rollbackOptimisticUpdate(n.activity_key),n=n.setStatus("POSTING");var o=Array.from(E({targetActivityKey:e,pendingCommentActivity:n})),a=o[0],i=o[1];return a.catch(function(t){var o=C.default.getInstance();return o.rollbackOptimisticUpdate(i),o.commitOptimisticUpdate(function(t){var o=D(n,i);return t.appendComment(e,o)}),Promise.reject(t)}),u.default.addedComment(),a.then(function(){return s.CommentsVortexLogger.log("retry-post-success")})},N=function(t){if(P("addFileComment",[t])){s.CommentsVortexLogger.log("add-comment-attempt");var e=y.default.state.activity.activity_key,n=Array.from(U({targetActivityKey:e,body:t})),o=n[1];return u.default.addedComment(),o.then(function(){return s.CommentsVortexLogger.log("add-comment-success")})}},R=function(t){var e=y.default.state.createAnnotation.annotation;if(null!=e&&P("addInlineAnnotation",[t])){s.CommentsVortexLogger.log("add-annotation-attempt");var n=Array.from(U({targetActivityKey:y.default.state.activity.activity_key,body:t,annotation:e})),o=n[0],a=n[1];return F(o),u.default.addedComment(),a.then(function(){return s.CommentsVortexLogger.log("add-annotation-success")})}},M=function(t){var e=t.targetActivityKey,n=t.body;if(P("addReply",[{targetActivityKey:e,body:n}])){s.CommentsVortexLogger.log("add-reply-attempt");var o=Array.from(U({targetActivityKey:e,body:n})),a=o[0],i=o[1];return F(a),u.default.addedComment(),i.then(function(){return s.CommentsVortexLogger.log("add-reply-success")})}},F=function(t){return a.defer(function(){return H({activityKey:t.activity_key,expandConversation:!1})})},j=function(t){var e=t.commentActivityKey;s.CommentsVortexLogger.log("delete-comment-attempt"),w.assert(null!=y.default.state.activity.findCommentByKey(e),"Comment activity to delete does not exist: "+e);var n=_.deleteComment({actorId:y.default.state.actorId,context:y.default.state.viewing.context,contextData:y.default.state.viewing.contextData,commentActivityKey:e,oref:y.default.state.oref});return k(n,function(t){return t.purgeCommentByKey(e)}),n.then(function(){return s.CommentsVortexLogger.log("delete-comment-success")})},G=function(t){var e,n=t.commentActivityKey,o=t.resolved;s.CommentsVortexLogger.log("set-resolved-attempt");var a=y.default.state.activity.findCommentByKey(n);w.assert(null!=a,"Comment activity to resolve/unresolve does not exist: "+n);var i=_.updateResolveComment({actorId:y.default.state.actorId,context:y.default.state.viewing.context,contextData:y.default.state.viewing.contextData,commentActivityKey:n,resolved:o,oref:y.default.state.oref});return e=a.comment.resolved?function(t){return t.unresolveCommentByKey(n)}:function(t){return t.resolveCommentByKey(n)},k(i,e),i.then(function(){return s.CommentsVortexLogger.log("set-resolved-success")})},Y=function(t){var e,n=t.enabled;s.CommentsVortexLogger.log("set-enabled-attempt");var o=_.updateCommentSetting({actorId:y.default.state.actorId,context:y.default.state.viewing.context,contextData:y.default.state.viewing.contextData,enableComment:n,oref:y.default.state.oref});return e=y.default.state.activity.feedback_off?function(t){return t.enableCommenting()}:function(t){return t.disableCommenting()},k(o,e),n?u.default.enableCommenting():u.default.disableCommenting(),o.then(function(){return s.CommentsVortexLogger.log("set-enabled-success")})},W=function(t){var e=t.subscribed,n=g.getActivityUser(y.default.state.actorId),o=y.default.state.activity.activity_key;if(!n.is_signed_in)return d.saveActionCreator({name:"setCommentSubscribed",fileActivityKey:o,args:arguments.slice()}),l.CommentsEvents.emit("show-sign-up-modal",{fileActivityKey:o,variant:I.CommentsSharedLinkSignupModals.SUBSCRIBE_VARIANT}),void d.logSignUpModal({fileActivityKey:o,originType:S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.SUBSCRIBE_BUTTON});if(!n.is_email_verified){var a=i.EmailVerification.get_for_user(n);return i.EmailVerification.set_should_use_simple_ui(!1),void a.show_verify_modal(null,r.SUBSCRIBE_TO_COMMENTS)}s.CommentsVortexLogger.log("set-subscribed-attempt");var c=_.updateFileActivitySubscription({actorId:y.default.state.actorId,context:y.default.state.viewing.context,contextData:y.default.state.viewing.contextData,subscribed:e,oref:y.default.state.oref});return e?c.then(function(){return L.Notify.success(K._("You have been subscribed."))}).catch(function(t){return L.Notify.error(K._("We failed to unsubscribe you.")),Promise.reject(t)}):c.then(function(){return L.Notify.success(K._("You have been unsubscribed."))}).catch(function(t){return L.Notify.error(K._("We failed to unsubscribe you.")),Promise.reject(t)}),c.then(function(){return s.CommentsVortexLogger.log("set-subscribe-success")})},q=function(t){var e=y.default.state.activity,n=e.findConversationByKey(t),o=g.getActivityUser(y.default.state.actorId);if(null!=n&&o.is_signed_in){var i=function(t){return!(t.is_pending||t.is_seen)},r=n.comment_activities.filter(i);if(i(n)&&r.push(n),r.length>0){s.CommentsVortexLogger.log("mark-conversation-seen-attempt");var c=a.map(r,"activity_key"),m=_.markCommentSeenBatch({isBackgroundRequest:!0,actorId:y.default.state.actorId,context:y.default.state.viewing.context,contextData:y.default.state.viewing.contextData,commentActivityKeys:c});return k(m,function(t){return e.markCommentSeenByKeyBatch(c)}),m.then(function(){return s.CommentsVortexLogger.log("mark-conversation-seen-success")})}}},H=function(t){var e=t.activityKey,n=t.expandConversation;return l.CommentsEvents.emit("reveal-comment-in-pane",{activityKey:e,expandConversation:n})},z=function(t){var e=y.default.state.activity;if(null!=e){var n=e.findConversationByKey(t);if(T(null!=n?n.comment.comment_metadata:void 0,function(t){return t.annotation})){var o=n.comment.comment_metadata,a=o.annotation,i=o.revision,r=c.Annotation.createAnnotationFromDict(a);return null!=i&&u.default.switchRevision({revision:i,commentActivity:n}),l.CommentsEvents.emit("reveal-annotation",{page:r.getFirstPdfPage(),commentActivity:n})}}},J=function(t){var e=y.default.state.activity,n=g.getActivityUser(y.default.state.actorId);if(y.default.state.viewing.file&&e&&t&&v.isRevisionOlderThan(e.latest_revision,t.latest_revision)){var o=v.getFileWithRevision(y.default.state.viewing.file,t.latest_revision);V.reduxSaveForwardRevision(o)}if(u.default.receiveFileActivity(t),n.is_signed_in&&null==e&&null!=t&&d.replayActionCreators({actionCreators:et,fileActivityKey:t.activity_key}),y.default.state.isPreviewReady&&null==e)return l.CommentsEvents.emit("preview-and-comments-ready")},Q=function(){var t=y.default.state.actorId,e=o.default.createElement(h.default,{onOpen:function(){return u.default.setShouldShowOnboarding(!1),_.markCommentingOnboardingSeen({actorId:t}).catch(function(){})}});return A.Modal.showInstance(e)},X=function(){if(s.CommentsVortexLogger.log("show-comments-attempt"),y.default.areCommentsHidden())return $(!0),u.default.showComments(),s.CommentsVortexLogger.log("show-comments-success")},Z=function(){if(s.CommentsVortexLogger.log("hide-comments-attempt"),!y.default.areCommentsHidden())return $(!1),u.default.hideComments(),s.CommentsVortexLogger.log("hide-comments-success")},$=function(t){return null!=y.default.state.actorId?_.setCommentingPaneVisibility({actorId:y.default.state.actorId,shouldShow:t}):_.setSessionCommentingPaneVisibility({shouldShow:t})},tt=function(){return _.setShowCommentsTutorial({actorId:y.default.state.actorId,shouldShow:!1})};l.CommentsEvents.on("file-activity-updated",J);var et=a.assignIn({},u.default,{addReply:M,addFileComment:N,addInlineAnnotation:R,retryPostingComment:B,deleteComment:j,setCommentResolved:G,setCommentSubscribed:W,setCommentsEnabled:Y,markConversationSeen:q,showOnboardingIfNecessary:O,revealCommentInPane:H,revealAnnotationInPreview:z,markCommentsTutorialAsDone:tt,showComments:X,hideComments:Z});e.default=et});
//# sourceMappingURL=action_creators.min.js-vflpW_cM8.map